<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×ª×Ÿ ×ª×’×•×‘×” | ×¤×¨×•×¤×™×œ×™×</title>
    <style>
        :root { --pink: #e91e63; --violet: #667eea; --admin-gold: #ffc107; }
        body { font-family: 'Inter', system-ui, sans-serif; background: #667eea; margin: 0; padding: 10px; direction: rtl; }
        
        header { 
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            padding: 20px; background: white; border-radius: 20px; margin-bottom: 20px;
        }
        @media (min-width: 600px) { header { flex-direction: row; justify-content: space-between; } }

        .auth-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        button { cursor: pointer; border: none; padding: 10px 15px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: 0.2s; }
        
        .btn-add { background: var(--pink); color: white; width: 100%; }
        @media (min-width: 600px) { .btn-add { width: auto; } }

        .btn-outline { background: #f1f1f1; color: #333; }
        .btn-primary { background: var(--violet); color: white; }
        
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid white; }

        .board { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) { .board { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); } }

        .card { background: white; border-radius: 20px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: right; }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .card textarea { width: 100%; border: none; outline: none; min-height: 80px; resize: none; font-size: 16px; direction: ltr; }

        /* ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ */
        #profileSettings { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; text-align: center; }
        .file-input-wrapper { margin: 15px 0; }
        #avatarPreview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 3px solid var(--violet); display: inline-block; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .user-list-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body id="mainBody">

<header>
    <div onclick="window.location.href=window.location.pathname" style="cursor:pointer">
        <h2 style="margin:0">ğŸš€ ×ª×Ÿ ×ª×’×•×‘×”</h2>
        <small id="userStatus" style="color: #666;">×˜×•×¢×Ÿ...</small>
    </div>
    <div class="auth-buttons">
        <button class="btn-outline" onclick="showUserList()">ğŸ‘¥ ××©×ª××©×™×</button>
        <button class="btn-add" id="addBtn">+ ×¤×•×¡×˜ ×—×“×©</button>
        <span id="guestSection">
            <button class="btn-primary" onclick="openModal('login')">×”×ª×—×‘×¨</button>
        </span>
        <span id="userSection" class="hidden">
            <button class="btn-outline" id="myProfileBtn">×¤×¨×•×¤×™×œ ×©×œ×™</button>
            <button class="btn-outline" onclick="window.logout()">×”×ª× ×ª×§</button>
        </span>
    </div>
</header>

<div id="profileSettings" class="hidden">
    <h3>×”×’×“×¨×•×ª ×¤×¨×•×¤×™×œ</h3>
    <img id="avatarPreview" src="https://ui-avatars.com/api/?name=User" alt="Preview">
    <div class="file-input-wrapper">
        <label for="filePicker" class="btn-outline" style="padding: 10px; display: inline-block; cursor: pointer;">×”×¢×œ×” ×ª××•× ×” ××”××›×©×™×¨ ğŸ“¸</label>
        <input type="file" id="filePicker" accept="image/*" style="display: none;">
    </div>
    <p id="uploadStatus" style="font-size: 12px; color: green;"></p>
</div>

<div class="board" id="board"></div>

<div class="modal-overlay" id="userListOverlay">
    <div class="modal">
        <h3>×¨×©×™××ª ××©×ª××©×™×</h3>
        <div id="usersContainer"></div>
        <button class="btn-outline" style="width:100%; margin-top:15px;" onclick="closeUserList()">×¡×’×•×¨</button>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h3 id="modalTitle">×›× ×™×¡×”</h3>
        <input type="email" id="authEmail" style="width:100%; padding:10px; margin-bottom:10px; box-sizing: border-box;" placeholder="××™××™×™×œ">
        <input type="password" id="authPass" style="width:100%; padding:10px; margin-bottom:10px; box-sizing: border-box;" placeholder="×¡×™×¡××”">
        <button class="btn-primary" style="width:100%" id="authSubmit">××™×©×•×¨</button>
        <button class="btn-outline" style="width:100%; margin-top:10px;" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAexYNdpzOgbji6Se7XCdeNBdQfn_LG0LQ",
    authDomain: "whitecivic-21e7f.firebaseapp.com",
    databaseURL: "https://whitecivic-21e7f-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "whitecivic-21e7f",
    storageBucket: "whitecivic-21e7f.firebasestorage.app",
    messagingSenderId: "315183180745",
    appId: "1:315183180745:web:6e71aa50d0b975d63c9618"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const urlParams = new URLSearchParams(window.location.search);
  const wallId = urlParams.get('user') || 'public';
  const SUPER_ADMIN = "anton@gmail.com";

  const getAv = (email, url) => url || `https://ui-avatars.com/api/?name=${email}&background=random`;

  onAuthStateChanged(auth, async (user) => {
    document.getElementById('guestSection').classList.toggle('hidden', !!user);
    document.getElementById('userSection').classList.toggle('hidden', !user);
    
    if (user) {
        document.getElementById('userStatus').innerText = user.email;
        document.getElementById('myProfileBtn').onclick = () => window.location.href = '?user=' + btoa(user.email);
        
        if (btoa(user.email) === wallId) {
            document.getElementById('profileSettings').classList.remove('hidden');
            const uSnap = await get(ref(db, 'users/' + btoa(user.email)));
            if (uSnap.val()?.avatar) document.getElementById('avatarPreview').src = uSnap.val().avatar;
        }
    }
  });

  // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ¸ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Ğ² Base64
  document.getElementById('filePicker').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° (Base64 ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ½Ğ° 33%, Ğ»ÑƒÑ‡ÑˆĞµ Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ´Ğ¾ 1-2Ğ¼Ğ±)
    if (file.size > 1048576) { 
        alert("×”×§×•×‘×¥ ×’×“×•×œ ××“×™! ×‘×—×¨ ×ª××•× ×” ×§×˜× ×” ×-1MB");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        const base64String = event.target.result;
        
        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ²ÑŒÑ
        document.getElementById('avatarPreview').src = base64String;
        
        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        update(ref(db, 'users/' + btoa(auth.currentUser.email)), { avatar: base64String })
            .then(() => {
                document.getElementById('uploadStatus').innerText = "×ª××•× ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”! âœ¨";
                setTimeout(() => location.reload(), 1000);
            });
    };
    reader.readAsDataURL(file);
  };

  window.showUserList = () => {
    document.getElementById('userListOverlay').style.display = 'flex';
    const cont = document.getElementById('usersContainer');
    cont.innerHTML = '×˜×•×¢×Ÿ...';
    
    onValue(ref(db, 'users'), (snap) => {
        cont.innerHTML = '';
        snap.forEach(child => {
            const u = child.val();
            const div = document.createElement('div');
            div.className = 'user-list-item';
            div.onclick = () => window.location.href = '?user=' + child.key;
            div.innerHTML = `
                <img src="${getAv(u.email, u.avatar)}" class="avatar">
                <span>${u.email}</span>
            `;
            cont.appendChild(div);
        });
    }, { onlyOnce: true });
  };
  window.closeUserList = () => document.getElementById('userListOverlay').style.display = 'none';

  onChildAdded(ref(db, 'walls/' + wallId), async (snap) => {
    const data = snap.val();
    const id = snap.key;
    const authorId = btoa(data.author);
    
    const div = document.createElement('div');
    div.id = id; div.className = 'card';
    div.innerHTML = `
        <div class="card-header">
            <img id="av-${id}" src="${getAv(data.author)}" class="avatar">
            <b onclick="window.location.href='?user=${authorId}'" style="cursor:pointer">${data.author.split('@')[0]}</b>
        </div>
        <textarea>${data.text || ''}</textarea>
    `;
    document.getElementById('board').prepend(div);

    onValue(ref(db, 'users/' + authorId), (uSnap) => {
        if (uSnap.val()?.avatar) document.getElementById(`av-${id}`).src = uSnap.val().avatar;
    });

    const area = div.querySelector('textarea');
    if (auth.currentUser && (auth.currentUser.email === data.author || auth.currentUser.email === SUPER_ADMIN)) {
        area.oninput = (e) => update(ref(db, `walls/${wallId}/${id}`), {text: e.target.value});
    } else {
        area.readOnly = true;
    }
  });

  document.getElementById('addBtn').onclick = () => {
    if (!auth.currentUser) return alert("×”×ª×—×‘×¨ ×›×“×™ ×œ×¤×¨×¡×!");
    push(ref(db, 'walls/' + wallId), { text: "", author: auth.currentUser.email });
  };

  window.openModal = (t) => { window.act = t; document.getElementById('modalOverlay').style.display='flex'; };
  window.closeModal = () => document.getElementById('modalOverlay').style.display='none';
  document.getElementById('authSubmit').onclick = async () => {
    const e = document.getElementById('authEmail').value, p = document.getElementById('authPass').value;
    try {
        if(window.act === 'register') {
            await createUserWithEmailAndPassword(auth, e, p);
            update(ref(db, 'users/' + btoa(e)), { email: e, role: (e === SUPER_ADMIN ? 'admin' : 'user') });
        } else await signInWithEmailAndPassword(auth, e, p);
        closeModal();
    } catch(err) { alert(err.message); }
  };
  window.logout = () => signOut(auth);
</script>
</body>
</html>
