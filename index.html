<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAR MEET | Social Network</title>
    <style>
        :root { --cm-blue: #007aff; --cm-bg: #0b0b0c; --cm-card: #1c1c1e; --cm-text: #f2f2f7; --cm-gray: #8e8e93; --cm-border: #2c2c2e; --cm-gold: #ffcc00; --cm-online: #34c759; --cm-red: #ff3b30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--cm-bg); margin: 0; direction: rtl; color: var(--cm-text); overflow-x: hidden; }
        header { background: rgba(28, 28, 30, 0.9); backdrop-filter: blur(10px); height: 60px; display: flex; justify-content: center; border-bottom: 1px solid var(--cm-border); position: sticky; top: 0; z-index: 100; }
        .header-content { width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .logo { font-weight: 900; font-size: 22px; cursor: pointer; color: white; text-decoration: none; }
        .logo span { color: var(--cm-blue); }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* Notifications Badge */
        .notif-btn { position: relative; cursor: pointer; font-size: 20px; margin-left: 15px; display: flex; align-items: center; }
        .notif-badge { position: absolute; top: -5px; right: -8px; background: var(--cm-red); color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; font-weight: bold; min-width: 12px; text-align: center; }

        /* Profile & Feed (Facebook Style) */
        .card { background: var(--cm-card); border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--cm-border); position: relative; }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .post-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; background: #333; cursor: pointer; }
        .feed-meta { display: flex; flex-direction: column; justify-content: center; }
        .author-line { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
        .feed-meta b { color: white; cursor: pointer; font-size: 15px; }
        .post-time { font-size: 11px; color: var(--cm-gray); margin-top: 2px; }
        .card-image { width: 100%; max-height: 400px; object-fit: cover; border-radius: 12px; margin-top: 10px; }
        
        .post-actions { margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--cm-border); display: flex; gap: 20px; font-size: 13px; color: var(--cm-gray); }
        .action-item { cursor: pointer; display: flex; align-items: center; gap: 4px; }

        /* Profile Card */
        .profile-card { background: var(--cm-card); border-radius: 20px; overflow: hidden; border: 1px solid var(--cm-border); margin-bottom: 20px; text-align: center; padding-bottom: 20px; }
        .avatar-container { position: relative; width: 90px; height: 90px; margin: -45px auto 0 auto; }
        .profile-avatar { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--cm-card); object-fit: cover; background: #333; }
        
        button { cursor: pointer; border: none; border-radius: 10px; font-weight: 600; padding: 8px 16px; }
        .btn-primary { background: var(--cm-blue); color: white; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="logo" onclick="location.href='index.html'">CAR<span>MEET</span></div>
        <div id="authNav" style="display:flex; align-items:center;">
            <span id="guestNav">
                <button class="btn-primary" onclick="openModal('register')">×”×¨×©××”</button>
                <button style="background:none; color:white;" onclick="openModal('login')">×›× ×™×¡×”</button>
            </span>
            <span id="userNav" class="hidden" style="display:flex; align-items:center;">
                <div class="notif-btn" onclick="alert('××™×Ÿ ×”×ª×¨××•×ª ×—×“×©×•×ª')">ğŸ””<span id="notifCount" class="notif-badge">0</span></div>
                <button class="btn-primary" onclick="goMyProfile()">×¤×¨×•×¤×™×œ</button>
                <button style="background:none; color:var(--cm-gray); font-size:12px;" id="logoutBtn">×™×¦×™××”</button>
            </span>
        </div>
    </div>
</header>

<div class="container">
    <div id="profileHeader" class="hidden">
        <div class="profile-card">
            <div style="height: 80px; background: linear-gradient(45deg, #1c1c1e, #007aff);"></div>
            <div class="avatar-container">
                <img id="pAvatar" class="profile-avatar" src="">
            </div>
            <div style="font-size:22px; font-weight:800; margin-top:10px;"><span id="pName"></span></div>
        </div>
    </div>

    <div class="card" id="postCreator">
        <textarea id="postInp" style="width:100%; background:none; border:none; color:white; outline:none; resize:none;" placeholder="×›×ª×•×‘ ××©×”×•..."></textarea>
        <button class="btn-primary" id="sendPost" style="float:left; margin-top:10px;">×¤×¨×¡×•×</button>
        <div style="clear:both;"></div>
    </div>

    <div id="board"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded, update, get, remove, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyAexYNdpzOgbji6Se7XCdeNBdQfn_LG0LQ", authDomain: "whitecivic-21e7f.firebaseapp.com", databaseURL: "https://whitecivic-21e7f-default-rtdb.europe-west1.firebasedatabase.app", projectId: "whitecivic-21e7f" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const q = new URLSearchParams(window.location.search);
    const profileId = q.get('user');
    let currentUser = null;

    onAuthStateChanged(auth, (u) => {
        if (u) {
            currentUser = u;
            document.getElementById('userNav').classList.remove('hidden');
            document.getElementById('guestNav').classList.add('hidden');
            listenToNotifications();
        }
        if (profileId) loadProfileInfo();
    });

    // ×¤×•× ×§×¦×™×™×ª ×©×œ×™×—×ª ×¤×•×¡×˜ ×¢× ×”×ª×¨××”
    document.getElementById('sendPost').onclick = async () => {
        if(!currentUser) return;
        const txt = document.getElementById('postInp').value;
        const myId = btoa(clean(currentUser.email).toLowerCase());
        
        const newPostRef = push(ref(db, 'feed'), { 
            from: clean(currentUser.email), 
            toId: profileId || 'public', 
            text: txt, 
            time: Date.now() 
        });

        // ×©×œ×™×—×ª ×”×ª×¨××” ×× ×”×¤×¨×¡×•× ×”×•× ×¢×œ ×§×™×¨ ×©×œ ××™×©×”×• ××—×¨
        if (profileId && profileId !== myId) {
            push(ref(db, `notifications/${profileId}`), {
                fromName: clean(currentUser.email),
                type: 'post',
                time: Date.now()
            });
        }
        document.getElementById('postInp').value = "";
    };

    // ×˜×¢×™× ×ª ×”×¤×™×“ (×ª×§×™×Ÿ ×’× ×‘×“×£ ×”×‘×™×ª ×•×’× ×‘×¤×¨×•×¤×™×œ)
    onChildAdded(ref(db, 'feed'), (snap) => {
        const d = snap.val(), id = snap.key;
        
        // ×¡×™× ×•×Ÿ ×¤×¨×•×¤×™×œ: ×”×¦×’ ×¨×§ ×¤×•×¡×˜×™× ×©×§×©×•×¨×™× ×œ×¤×¨×•×¤×™×œ ×”× ×•×›×—×™
        if (profileId) {
            const isFromProfile = btoa(d.from.toLowerCase()) === profileId;
            const isToProfile = d.toId === profileId;
            if (!isFromProfile && !isToProfile) return;
        }

        const card = document.createElement('div');
        card.className = 'card';
        
        onValue(ref(db, `feed/${id}`), async (s) => {
            if(!s.exists()) { card.remove(); return; }
            const post = s.val();
            
            // ×¢×™×¦×•×‘ "×™×•×¡×™ â–¸ ×× ×˜×•×Ÿ"
// ×˜×¢×™× ×ª ×”×¤×™×“ (×ª×§×™×Ÿ ×’× ×‘×“×£ ×”×‘×™×ª ×•×’× ×‘×¤×¨×•×¤×™×œ)
    onChildAdded(ref(db, 'feed'), (snap) => {
        const d = snap.val(), id = snap.key;
        
        // ×¡×™× ×•×Ÿ ×¤×¨×•×¤×™×œ: ×”×¦×’ ×¨×§ ×¤×•×¡×˜×™× ×©×§×©×•×¨×™× ×œ×¤×¨×•×¤×™×œ ×”× ×•×›×—×™
        if (profileId) {
            const isFromProfile = btoa(clean(d.from).toLowerCase()) === profileId;
            const isToProfile = d.toId === profileId;
            if (!isFromProfile && !isToProfile) return;
        }

        const card = document.createElement('div');
        card.className = 'card';
        // ×”×•×¡×¤×” ×œ×œ×•×— ××™×“
        document.getElementById('board').prepend(card);
        
        // ×”××–× ×” ×œ×©×™× ×•×™×™× ×‘×¤×•×¡×˜ (×œ×™×™×§×™× ×•×›×“×•××”)
        onValue(ref(db, `feed/${id}`), async (s) => {
            if(!s.exists()) { card.remove(); return; }
            const post = s.val();
            const fromUser = clean(post.from);
            const fromId = btoa(fromUser.toLowerCase());

            // ×‘× ×™×™×ª ×©×•×¨×ª ×”×›×•×ª×‘ ×•×”××§×‘×œ
            let authorHtml = `<b onclick="location.href='?user=${fromId}'">${fromUser}</b>`;
            
            // ×‘×“×™×§×” ×× ×”×¤×•×¡×˜ × ×›×ª×‘ ×¢×œ ×§×™×¨ ×©×œ ××™×©×”×• ××—×¨
            if (post.toId && post.toId !== 'public' && post.toId !== fromId) {
                const targetSnap = await get(ref(db, 'users/' + post.toId));
                let targetName = "××©×ª××©"; // ×‘×¨×™×¨×ª ××—×“×œ
                if (targetSnap.exists()) {
                    targetName = targetSnap.val().username;
                }
                authorHtml += ` <span style="color:var(--cm-gray); margin: 0 4px; font-weight:normal;">â–¸</span> <b onclick="location.href='?user=${post.toId}'">${targetName}</b>`;
            }

            card.innerHTML = `
                <div class="post-header">
                    <img src="https://ui-avatars.com/api/?name=${fromUser}&background=random" class="post-avatar">
                    <div class="feed-meta">
                        <div class="author-line">
                            ${authorHtml}
                        </div>
                        <span class="post-time">${new Date(post.time).toLocaleString('he-IL')}</span>
                    </div>
                </div>
                <div style="white-space:pre-wrap; font-size:15px; padding: 5px 2px;">${post.text}</div>
                <div class="post-actions">
                    <div class="action-item" onclick="likePost('${id}', '${fromId}')">
                        â¤ï¸ <span>${post.likes ? Object.keys(post.likes).length : 0}</span> ×œ×™×™×§×™×
                    </div>
                </div>
            `;
        });
    });

    // ××¢×¨×›×ª ×”×ª×¨××•×ª ×œ×™×™×§×™×
    window.likePost = async (postId, authorId) => {
        if(!currentUser) return;
        const myId = btoa(clean(currentUser.email).toLowerCase());
        await set(ref(db, `feed/${postId}/likes/${myId}`), true);
        
        if (myId !== authorId) {
            push(ref(db, `notifications/${authorId}`), {
                fromName: clean(currentUser.email),
                type: 'like',
                time: Date.now()
            });
        }
    };

    function listenToNotifications() {
        const myId = btoa(clean(currentUser.email).toLowerCase());
        onValue(ref(db, `notifications/${myId}`), (snap) => {
            const count = snap.size || 0;
            const badge = document.getElementById('notifCount');
            badge.innerText = count;
            badge.style.display = count > 0 ? 'block' : 'none';
        });
    }

    async function loadProfileInfo() {
        document.getElementById('profileHeader').classList.remove('hidden');
        const s = await get(ref(db, 'users/' + profileId));
        if(s.exists()) {
            const d = s.val();
            document.getElementById('pName').innerText = d.username;
            document.getElementById('pAvatar').src = d.avatar || `https://ui-avatars.com/api/?name=${d.username}`;
        }
    }

    const clean = (e) => e ? e.split('@')[0] : "";
    window.goMyProfile = () => location.href = '?user=' + btoa(clean(currentUser.email).toLowerCase());
</script>
</body>
</html>
