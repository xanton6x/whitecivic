<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Board: Likes & Comments</title>
    <style>
        :root { --pink: #e91e63; --violet: #667eea; --bg: #f0f2f5; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; transition: background 0.5s; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 25px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: 20px; margin-bottom: 30px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .search-box { flex-grow: 1; margin: 0 20px; }
        .search-box input { width: 100%; padding: 10px 15px; border-radius: 25px; border: 1px solid #ddd; outline: none; }

        button { cursor: pointer; border: none; font-weight: 600; transition: 0.2s; }
        .btn-add { background: var(--pink); color: white; padding: 10px 20px; border-radius: 12px; }
        .btn-outline { background: #f1f3f5; padding: 10px 15px; border-radius: 12px; }

        .profile-header { text-align: center; margin-bottom: 30px; color: white; background: var(--violet); padding: 40px; border-radius: 25px; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; object-fit: cover; background: #eee; }
        
        .board { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .mini-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        
        .card textarea { width: 100%; border: none; outline: none; min-height: 80px; resize: none; font-size: 16px; background: transparent; }
        
        /* Likes & Comments UI */
        .card-footer { display: flex; gap: 15px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .action-btn { background: none; color: #666; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .action-btn:hover { color: var(--pink); }

        .comments-section { background: #f8f9fa; border-radius: 12px; padding: 10px; margin-top: 10px; font-size: 13px; }
        .comment-item { margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        .comment-input { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 5px 10px; margin-top: 5px; box-sizing: border-box; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 25px; border-radius: 20px; width: 320px; }
        .hidden { display: none; }
    </style>
</head>
<body id="mainBody">

<header>
    <div onclick="goToHome()" style="cursor:pointer; color: var(--violet); font-weight: bold;">üöÄ Board</div>
    <div class="search-box"><input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ Email..."></div>
    <div style="display: flex; gap: 10px;">
        <button class="btn-add" id="addBtn">+ –ü–æ—Å—Ç</button>
        <div id="guestSection"><button class="btn-outline" onclick="openModal('login')">–í—Ö–æ–¥</button></div>
        <div id="userSection" class="hidden">
            <button class="btn-outline" id="myProfileBtn">–ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="btn-outline" onclick="window.logout()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>
</header>

<div id="profileInfo" class="profile-header hidden">
    <img id="headerAvatar" class="profile-avatar" src="">
    <h1 id="profileName" style="margin: 0;">–ü—Ä–æ—Ñ–∏–ª—å</h1>
    <div id="ownerControls" class="hidden" style="margin-top: 15px;">
        <input type="text" id="avatarUrlInput" placeholder="URL –ê–≤–∞—Ç–∞—Ä–∫–∏" style="padding: 8px; border-radius: 8px;">
        <input type="color" id="wallColorPicker">
        <button class="btn-add" id="saveProfileBtn">–û–ö</button>
    </div>
</div>

<div class="board" id="board"></div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h3 id="modalTitle">–í—Ö–æ–¥</h3>
        <input type="email" id="authEmail" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Email">
        <input type="password" id="authPass" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn-add" style="width:100%" id="authSubmit">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        <button style="width:100%; margin-top:5px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update, onValue, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAexYNdpzOgbji6Se7XCdeNBdQfn_LG0LQ",
    authDomain: "whitecivic-21e7f.firebaseapp.com",
    databaseURL: "https://whitecivic-21e7f-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "whitecivic-21e7f",
    storageBucket: "whitecivic-21e7f.firebasestorage.app",
    messagingSenderId: "315183180745",
    appId: "1:315183180745:web:6e71aa50d0b975d63c9618"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const urlParams = new URLSearchParams(window.location.search);
  const wallOwnerId = urlParams.get('user') || 'public';

  window.goToHome = () => window.location.href = window.location.pathname;
  window.goToProfile = (email) => { if(email && email !== 'Anonymous') window.location.href = `?user=${btoa(email)}`; };

  // --- –õ–û–ì–ò–ö–ê –ü–û–°–¢–û–í ---
  onChildAdded(ref(db, 'walls/' + wallOwnerId), (snap) => {
    const data = snap.val();
    const id = snap.key;
    const card = document.createElement('div');
    card.id = id; card.className = 'card';
    card.innerHTML = `
        <div class="card-header">
            <img class="mini-avatar" id="av-${id}" src="https://ui-avatars.com/api/?name=${data.author}">
            <b style="cursor:pointer" onclick="goToProfile('${data.author}')">${data.author.split('@')[0]}</b>
        </div>
        <textarea id="text-${id}">${data.text || ''}</textarea>
        <div class="card-footer">
            <button class="action-btn" id="like-${id}">‚ù§Ô∏è <span id="count-${id}">${data.likes || 0}</span></button>
            <button class="action-btn" onclick="document.getElementById('comm-box-${id}').classList.toggle('hidden')">üí¨ –ö–æ–º–º–µ–Ω—Ç—ã</button>
        </div>
        <div id="comm-box-${id}" class="comments-section hidden">
            <div id="list-${id}"></div>
            <input type="text" class="comment-input" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç..." id="inp-${id}">
        </div>
    `;
    document.getElementById('board').prepend(card);

    // –õ–∞–π–∫–∏
    document.getElementById(`like-${id}`).onclick = () => {
        update(ref(db, `walls/${wallOwnerId}/${id}`), { likes: increment(1) });
    };

    // –ö–æ–º–º–µ–Ω—Ç—ã
    document.getElementById(`inp-${id}`).onkeypress = (e) => {
        if (e.key === 'Enter' && auth.currentUser) {
            const commRef = ref(db, `walls/${wallOwnerId}/${id}/comments`);
            push(commRef, { text: e.target.value, user: auth.currentUser.email });
            e.target.value = '';
        } else if (e.key === 'Enter') alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ç—å!");
    };

    // –°–ª—É—à–∞—Ç–µ–ª—å –∫–æ–º–º–µ–Ω—Ç–æ–≤
    onValue(ref(db, `walls/${wallOwnerId}/${id}/comments`), (cSnap) => {
        const list = document.getElementById(`list-${id}`);
        list.innerHTML = '';
        cSnap.forEach(child => {
            list.innerHTML += `<div class="comment-item"><b>${child.val().user.split('@')[0]}:</b> ${child.val().text}</div>`;
        });
    });

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    const area = document.getElementById(`text-${id}`);
    if (auth.currentUser?.email !== data.author) area.readOnly = true;
    area.oninput = (e) => update(ref(db, `walls/${wallOwnerId}/${id}`), {text: e.target.value});
  });

  // --- –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò ---
  onAuthStateChanged(auth, (user) => {
    document.getElementById('guestSection').classList.toggle('hidden', !!user);
    document.getElementById('userSection').classList.toggle('hidden', !user);
    if (user) document.getElementById('myProfileBtn').onclick = () => goToProfile(user.email);
    if (user && btoa(user.email) === wallOwnerId) document.getElementById('ownerControls').classList.remove('hidden');
  });

  document.getElementById('addBtn').onclick = () => {
    const author = auth.currentUser ? auth.currentUser.email : "Anonymous";
    push(ref(db, 'walls/' + wallOwnerId), { text: "", author, likes: 0, ts: Date.now() });
  };

  document.getElementById('saveProfileBtn').onclick = () => {
    update(ref(db, 'profiles/' + wallOwnerId), { 
        color: document.getElementById('wallColorPicker').value,
        avatar: document.getElementById('avatarUrlInput').value 
    });
    location.reload();
  };

  // –ü–æ–∏—Å–∫
  document.getElementById('searchInput').onkeypress = (e) => {
    if(e.key === 'Enter') goToProfile(e.target.value);
  };

  // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ª–∞–π–∫–∏ –∏ —Ç–µ–∫—Å—Ç)
  onChildChanged(ref(db, 'walls/' + wallOwnerId), snap => {
    const data = snap.val();
    document.getElementById(`count-${snap.key}`).innerText = data.likes || 0;
    const area = document.getElementById(`text-${snap.key}`);
    if (document.activeElement !== area) area.value = data.text || '';
  });

  // Auth Modals
  window.openModal = (t) => { window.authT = t; document.getElementById('modalOverlay').style.display='flex'; };
  window.closeModal = () => document.getElementById('modalOverlay').style.display='none';
  document.getElementById('authSubmit').onclick = async () => {
    const e = document.getElementById('authEmail').value;
    const p = document.getElementById('authPass').value;
    try {
        if(window.authT === 'register') await createUserWithEmailAndPassword(auth, e, p);
        else await signInWithEmailAndPassword(auth, e, p);
        closeModal();
    } catch(err) { alert(err.message); }
  };
  window.logout = () => signOut(auth);
</script>
</body>
</html>
