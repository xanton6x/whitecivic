<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padlet: Hybrid Mode</title>
    <style>
        :root { --pink: #e91e63; --violet: #667eea; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); background-attachment: fixed; margin: 0; padding: 20px; color: #333; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 25px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .auth-group { display: flex; gap: 8px; }
        .hidden { display: none !important; }
        
        input { padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; outline: none; }
        button { cursor: pointer; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 600; transition: 0.2s; }
        .btn-add { background: var(--pink); color: white; font-size: 16px; }
        .btn-add:hover { transform: scale(1.05); }
        .btn-login { background: #eee; }

        .board { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 18px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); position: relative; }
        .card textarea { width: 100%; border: none; outline: none; min-height: 100px; font-size: 16px; resize: none; background: transparent; }
        .author-info { font-size: 11px; color: #999; margin-bottom: 8px; font-style: italic; }
        
        .btn-del { 
            background: #fff0f0; color: #ff4757; font-size: 11px; margin-top: 15px; 
            display: none; width: 100%; 
        }
        .admin-mode .btn-del { display: block; }
    </style>
</head>
<body id="appBody">

<header>
    <div>
        <h2 style="margin:0; color: var(--violet);">✨ SimpleBoard</h2>
        <small id="status">Анонимный режим</small>
    </div>

    <div class="auth-group">
        <div id="guestUI" class="auth-group">
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Пароль">
            <button class="btn-login" onclick="window.handleAuth('login')">Войти</button>
            <button style="background: var(--violet); color: white;" onclick="window.handleAuth('register')">Регистрация</button>
        </div>
        <div id="userUI" class="auth-group hidden">
            <span id="userDisplay" style="align-self: center; margin-right: 10px; font-weight: bold;"></span>
            <button onclick="window.handleAuth('logout')">Выйти</button>
        </div>
        <button class="btn-add" id="addBtn">+ Создать пост</button>
    </div>
</header>

<div class="board" id="board"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAexYNdpzOgbji6Se7XCdeNBdQfn_LG0LQ",
  authDomain: "whitecivic-21e7f.firebaseapp.com",
  databaseURL: "https://whitecivic-21e7f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "whitecivic-21e7f",
  storageBucket: "whitecivic-21e7f.firebasestorage.app",
  messagingSenderId: "315183180745",
  appId: "1:315183180745:web:6e71aa50d0b975d63c9618",
  measurementId: "G-Z7ZPZ5LNPV"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const cardsRef = ref(db, 'cards');

  const ADMIN_EMAIL = "admin@test.com"; // ЗАМЕНИТЕ НА ВАШ
  let currentUser = null;

  // Аутентификация
  window.handleAuth = async (type) => {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;
    try {
        if (type === 'register') await createUserWithEmailAndPassword(auth, email, pass);
        if (type === 'login') await signInWithEmailAndPassword(auth, email, pass);
        if (type === 'logout') await signOut(auth);
    } catch (e) { alert("Ошибка: " + e.message); }
  };

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    const isGuest = !user;
    document.getElementById('guestUI').classList.toggle('hidden', !isGuest);
    document.getElementById('userUI').classList.toggle('hidden', isGuest);
    
    if (user) {
        document.getElementById('userDisplay').innerText = user.email;
        document.getElementById('status').innerText = "Вы вошли в систему";
        if (user.email === ADMIN_EMAIL) document.body.classList.add('admin-mode');
    } else {
        document.body.classList.remove('admin-mode');
        document.getElementById('status').innerText = "Анонимный режим (лимит: 1 пост)";
    }
  });

  // Логика добавления поста
  document.getElementById('addBtn').onclick = () => {
    if (!currentUser) {
        // Проверка лимита для анонима
        const hasPosted = localStorage.getItem('anon_posted');
        if (hasPosted) {
            alert("Вы уже создали один анонимный пост. Пожалуйста, зарегистрируйтесь, чтобы создавать больше!");
            return;
        }
        // Если лимит не исчерпан, создаем анонимно
        push(cardsRef, { text: "", author: "Аноним", timestamp: Date.now() });
        localStorage.setItem('anon_posted', 'true');
    } else {
        // Для залогиненных лимита нет
        push(cardsRef, { text: "", author: currentUser.email, timestamp: Date.now() });
    }
  };

  // Отрисовка
  function renderCard(id, data) {
    let cardEl = document.getElementById(id);
    if (!cardEl) {
        cardEl = document.createElement('div');
        cardEl.id = id;
        cardEl.className = 'card';
        cardEl.innerHTML = `
            <div class="author-info">От: ${data.author}</div>
            <textarea placeholder="Напишите здесь..."></textarea>
            <button class="btn-del">Удалить (только Админ)</button>
        `;
        document.getElementById('board').prepend(cardEl);
        
        cardEl.querySelector('textarea').oninput = (e) => {
            update(ref(db, 'cards/' + id), { text: e.target.value });
        };
        cardEl.querySelector('.btn-del').onclick = () => remove(ref(db, 'cards/' + id));
    }
    const area = cardEl.querySelector('textarea');
    if (document.activeElement !== area) area.value = data.text || "";
  }

  onChildAdded(cardsRef, (snap) => renderCard(snap.key, snap.val()));
  onChildChanged(cardsRef, (snap) => renderCard(snap.key, snap.val()));
  onChildRemoved(cardsRef, (snap) => document.getElementById(snap.key)?.remove());

</script>
</body>
</html>
