<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarRate: –û—Ü–µ–Ω–∏ —Ç–∞—á–∫—É</title>
    <style>
        :root { --accent: #00d2ff; --dark: #2d3436; --card: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; margin: 0; padding: 20px; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 25px; background: rgba(0,0,0,0.8); border-radius: 15px; margin-bottom: 30px; border: 1px solid #444;
        }

        .search-box input { background: #333; border: 1px solid #555; color: white; padding: 10px; border-radius: 8px; width: 250px; }
        
        button { cursor: pointer; border: none; font-weight: bold; border-radius: 8px; padding: 10px 15px; }
        .btn-main { background: var(--accent); color: black; }
        
        .profile-card { 
            background: linear-gradient(45deg, #2d3436, #000); padding: 30px; border-radius: 20px; 
            text-align: center; border: 1px solid var(--accent); margin-bottom: 30px;
        }
        .car-info { font-size: 1.2rem; color: var(--accent); margin: 10px 0; }
        .average-score { font-size: 3rem; font-weight: 900; margin: 10px 0; }

        .board { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: var(--card); color: #333; border-radius: 15px; padding: 20px; position: relative; }
        .rating-badge { 
            position: absolute; top: -10px; right: -10px; background: black; color: var(--accent); 
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid var(--accent);
        }

        .rate-select { padding: 5px; border-radius: 5px; margin-bottom: 10px; width: 100%; border: 1px solid #ccc; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; color: black; padding: 30px; border-radius: 15px; width: 300px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div onclick="goToHome()" style="cursor:pointer; font-size: 24px;">üèéÔ∏è <span style="color:var(--accent)">Car</span>Rate</div>
    <div class="search-box"><input type="text" id="searchInput" placeholder="–ù–∞–π—Ç–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (email)..."></div>
    <div style="display: flex; gap: 10px;">
        <div id="guestSection"><button class="btn-main" onclick="openModal('login')">–í—Ö–æ–¥</button></div>
        <div id="userSection" class="hidden">
            <button class="btn-main" id="myProfileBtn">–ú–æ–π –ì–∞—Ä–∞–∂</button>
            <button style="background:#ff7675" onclick="window.logout()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>
</header>

<div id="profileInfo" class="profile-card hidden">
    <h1 id="profileName" style="margin:0">–ì–∞—Ä–∞–∂</h1>
    <div class="car-info" id="carModelDisplay">–ê–≤—Ç–æ: –ù–µ —É–∫–∞–∑–∞–Ω–æ</div>
    <div class="average-score" id="avgScore">--</div>
    <div style="font-size: 0.8rem;">–û–ë–©–ò–ô –†–ï–ô–¢–ò–ù–ì –ê–í–¢–û</div>
    
    <div id="ownerControls" class="hidden" style="margin-top:20px; border-top: 1px dashed #555; padding-top:15px;">
        <input type="text" id="carModelInput" placeholder="–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ..." style="padding:8px; border-radius:5px;">
        <button class="btn-main" id="saveProfileBtn">–û–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ</button>
    </div>
</div>

<div style="margin-bottom: 20px;">
    <h3>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –∏ –æ—Ü–µ–Ω–∫—É:</h3>
    <select id="rateVal" class="rate-select" style="width: 100px; margin-right: 10px;">
        <option value="10">10/10 - –ò–¥–µ–∞–ª</option>
        <option value="9">9/10</option>
        <option value="8">8/10</option>
        <option value="7">7/10</option>
        <option value="6">6/10</option>
        <option value="5">5/10 - –°—Ä–µ–¥–Ω–µ</option>
        <option value="1">1/10 - –í–µ–¥—Ä–æ</option>
    </select>
    <button class="btn-main" id="addBtn">–û—Ü–µ–Ω–∏—Ç—å —Ç–∞—á–∫—É</button>
</div>

<div class="board" id="board"></div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h3 id="modalTitle">–í—Ö–æ–¥</h3>
        <input type="email" id="authEmail" style="width:100%; margin-bottom:10px; padding:8px;" placeholder="Email">
        <input type="password" id="authPass" style="width:100%; margin-bottom:10px; padding:8px;" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn-main" style="width:100%" id="authSubmit">–û–ö</button>
        <button onclick="closeModal()" style="width:100%; background:none; margin-top:10px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAexYNdpzOgbji6Se7XCdeNBdQfn_LG0LQ",
    authDomain: "whitecivic-21e7f.firebaseapp.com",
    databaseURL: "https://whitecivic-21e7f-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "whitecivic-21e7f",
    storageBucket: "whitecivic-21e7f.firebasestorage.app",
    messagingSenderId: "315183180745",
    appId: "1:315183180745:web:6e71aa50d0b975d63c9618"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const urlParams = new URLSearchParams(window.location.search);
  const wallOwnerId = urlParams.get('user') || 'public';

  window.goToHome = () => window.location.href = window.location.pathname;
  window.goToProfile = (email) => { if(email && email !== 'Anonymous') window.location.href = `?user=${btoa(email)}`; };

  // --- –î–ê–ù–ù–´–ï –ü–†–û–§–ò–õ–Ø ---
  if (wallOwnerId !== 'public') {
    onValue(ref(db, 'profiles/' + wallOwnerId), (snap) => {
        const data = snap.val() || {};
        document.getElementById('profileName').innerText = `–í–ª–∞–¥–µ–ª–µ—Ü: ${atob(wallOwnerId).split('@')[0]}`;
        document.getElementById('carModelDisplay').innerText = `üöó –ê–≤—Ç–æ: ${data.car || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}`;
        document.getElementById('profileInfo').classList.remove('hidden');
    });

    // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
    onValue(ref(db, 'walls/' + wallOwnerId), (snap) => {
        let total = 0, count = 0;
        snap.forEach(child => {
            if(child.val().rate) { total += parseInt(child.val().rate); count++; }
        });
        document.getElementById('avgScore').innerText = count > 0 ? (total/count).toFixed(1) : '--';
    });
  }

  onAuthStateChanged(auth, (user) => {
    document.getElementById('guestSection').classList.toggle('hidden', !!user);
    document.getElementById('userSection').classList.toggle('hidden', !user);
    if (user && btoa(user.email) === wallOwnerId) document.getElementById('ownerControls').classList.remove('hidden');
    if (user) document.getElementById('myProfileBtn').onclick = () => goToProfile(user.email);
  });

  document.getElementById('saveProfileBtn').onclick = () => {
    const car = document.getElementById('carModelInput').value;
    update(ref(db, 'profiles/' + wallOwnerId), { car });
    alert("–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
  };

  // --- –ü–û–°–¢–ò–ù–ì –û–¢–ó–´–í–ê ---
  document.getElementById('addBtn').onclick = () => {
    const rate = document.getElementById('rateVal').value;
    const author = auth.currentUser ? auth.currentUser.email : "Anonymous";
    if (!auth.currentUser && localStorage.getItem('did_post_anon')) return alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –±–æ–ª—å—à–µ!");
    
    push(ref(db, 'walls/' + wallOwnerId), { 
        text: "", 
        author: author, 
        rate: rate,
        ts: Date.now() 
    });
    if (!auth.currentUser) localStorage.setItem('did_post_anon', 'true');
  };

  onChildAdded(ref(db, 'walls/' + wallOwnerId), (snap) => {
    const data = snap.val();
    const id = snap.key;
    const div = document.createElement('div');
    div.id = id; div.className = 'card';
    div.innerHTML = `
        <div class="rating-badge">${data.rate || '?'}</div>
        <small onclick="goToProfile('${data.author}')" style="cursor:pointer">–û—Ü–µ–Ω–∫–∞ –æ—Ç: <b>${data.author}</b></small>
        <textarea placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ü–µ–Ω–∫–µ...">${data.text || ''}</textarea>
        ${(auth.currentUser?.email === data.author) ? `<button onclick="remove(ref(db, 'walls/${wallOwnerId}/${id}'))" style="font-size:10px; color:red; border:1px solid red; background:none;">–£–¥–∞–ª–∏—Ç—å –º–æ–π –æ—Ç–∑—ã–≤</button>` : ''}
    `;
    document.getElementById('board').prepend(div);
    
    const area = div.querySelector('textarea');
    if (auth.currentUser?.email !== data.author) area.readOnly = true;
    area.oninput = (e) => update(ref(db, `walls/${wallOwnerId}/${id}`), {text: e.target.value});
  });

  // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (Auth, Search)
  window.openModal = (t) => { window.authT = t; document.getElementById('modalOverlay').style.display='flex'; };
  window.closeModal = () => document.getElementById('modalOverlay').style.display='none';
  document.getElementById('authSubmit').onclick = async () => {
    const e = document.getElementById('authEmail').value, p = document.getElementById('authPass').value;
    try {
        if(window.authT === 'register') await createUserWithEmailAndPassword(auth, e, p);
        else await signInWithEmailAndPassword(auth, e, p);
        closeModal();
    } catch(err) { alert(err.message); }
  };
  window.logout = () => signOut(auth);
  document.getElementById('searchInput').onkeypress = (e) => { if(e.key === 'Enter') goToProfile(e.target.value); };
  onChildRemoved(ref(db, 'walls/' + wallOwnerId), s => document.getElementById(s.key)?.remove());
</script>
</body>
</html>
