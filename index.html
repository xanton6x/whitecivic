<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Padlet Mobile</title>
    <style>
        :root { --pink: #e91e63; --violet: #667eea; }
        body { font-family: 'Inter', sans-serif; background: #667eea; margin: 0; padding: 10px; }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ö–µ–¥–µ—Ä */
        header { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 15px;
            padding: 20px; 
            background: white; 
            border-radius: 20px; 
            margin-bottom: 20px;
            text-align: center;
        }

        @media (min-width: 600px) {
            header { flex-direction: row; justify-content: space-between; text-align: left; }
        }

        .auth-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        
        button { 
            cursor: pointer; border: none; padding: 12px 18px; 
            border-radius: 12px; font-weight: 600; font-size: 14px;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.95); }

        .btn-add { background: var(--pink); color: white; width: 100%; }
        @media (min-width: 600px) { .btn-add { width: auto; } }

        .btn-outline { background: #f1f1f1; color: #333; }
        .btn-primary { background: var(--violet); color: white; }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .board { 
            display: grid; 
            grid-template-columns: 1fr; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            gap: 15px; 
        }

        @media (min-width: 768px) {
            .board { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        }

        .card { 
            background: white; 
            border-radius: 20px; 
            padding: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card textarea { 
            width: 100%; border: none; outline: none; 
            min-height: 120px; resize: none; font-size: 16px; /* 16px –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –≤ iOS */
            padding: 5px 0;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .modal { 
            background: white; 
            padding: 25px; 
            border-radius: 20px; 
            width: 90%; 
            max-width: 350px; 
        }
        
        .modal input { 
            width: 100%; padding: 15px; margin: 10px 0; 
            border: 1px solid #ddd; border-radius: 12px; 
            box-sizing: border-box; font-size: 16px;
        }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .admin-only { display: none; background: #fff0f0; color: #ff4757; width: 100%; margin-top: 10px; padding: 10px; }
        .admin-mode .admin-only { display: block; }
        .hidden { display: none; }
    </style>
</head>
<body id="mainBody">

<header>
    <div onclick="window.location.href=window.location.pathname" style="cursor:pointer">
        <h2 style="margin:0">üöÄ MyBoard</h2>
        <small id="userStatus" style="color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</small>
    </div>
    <div class="auth-buttons">
        <button class="btn-add" id="addBtn">+ –ü–æ—Å—Ç</button>
        <span id="guestSection">
            <button class="btn-outline" onclick="openModal('login')">–í–æ–π—Ç–∏</button>
            <button class="btn-primary" onclick="openModal('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </span>
        <span id="userSection" class="hidden">
            <button class="btn-outline" id="myProfileBtn">–ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="btn-outline" onclick="window.logout()">–í—ã—Ö–æ–¥</button>
        </span>
    </div>
</header>

<div class="board" id="board"></div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h3 id="modalTitle" style="margin-top:0">–í—Ö–æ–¥</h3>
        <input type="email" id="authEmail" placeholder="Email">
        <input type="password" id="authPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn-primary" style="width:100%" id="authSubmit">–ì–æ—Ç–æ–≤–æ</button>
        <button class="btn-outline" style="width:100%; margin-top:10px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAexYNdpzOgbji6Se7XCdeNBdQfn_LG0LQ",
    authDomain: "whitecivic-21e7f.firebaseapp.com",
    databaseURL: "https://whitecivic-21e7f-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "whitecivic-21e7f",
    storageBucket: "whitecivic-21e7f.firebasestorage.app",
    messagingSenderId: "315183180745",
    appId: "1:315183180745:web:6e71aa50d0b975d63c9618"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const urlParams = new URLSearchParams(window.location.search);
  const wallId = urlParams.get('user') || 'public';
  const cardsRef = ref(db, 'walls/' + wallId);

  const ADMIN_EMAIL = "admin@test.com"; 
  let currentAction = 'login';

  window.openModal = (type) => {
    currentAction = type;
    document.getElementById('modalTitle').innerText = type === 'login' ? '–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
    document.getElementById('modalOverlay').style.display = 'flex';
  };
  window.closeModal = () => document.getElementById('modalOverlay').style.display = 'none';

  document.getElementById('authSubmit').onclick = async () => {
    const email = document.getElementById('authEmail').value;
    const pass = document.getElementById('authPass').value;
    try {
        if (currentAction === 'register') await createUserWithEmailAndPassword(auth, email, pass);
        else await signInWithEmailAndPassword(auth, email, pass);
        closeModal();
    } catch (e) { alert(e.message); }
  };

  window.logout = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    document.getElementById('guestSection').classList.toggle('hidden', !!user);
    document.getElementById('userSection').classList.toggle('hidden', !user);
    document.getElementById('userStatus').innerText = user ? user.email : "–ê–Ω–æ–Ω–∏–º–Ω—ã–π —Ä–µ–∂–∏–º";
    
    if (user) {
        document.getElementById('myProfileBtn').onclick = () => {
            window.location.href = window.location.pathname + '?user=' + btoa(user.email);
        };
        if (user.email === ADMIN_EMAIL) document.body.classList.add('admin-mode');
    }
  });

  document.getElementById('addBtn').onclick = () => {
    if (!auth.currentUser) {
        if (localStorage.getItem('did_post_anon')) return alert("–õ–∏–º–∏—Ç! –í–æ–π–¥–∏—Ç–µ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤.");
        push(cardsRef, { text: "", author: "Anonymous" });
        localStorage.setItem('did_post_anon', 'true');
    } else {
        push(cardsRef, { text: "", author: auth.currentUser.email });
    }
  };

  onChildAdded(cardsRef, snap => {
    const data = snap.val();
    const id = snap.key;
    const div = document.createElement('div');
    div.id = id; div.className = 'card';
    div.innerHTML = `
        <div style="margin-bottom:10px;">
            <small style="cursor:pointer; color:var(--violet); font-weight:bold;" onclick="window.location.href='?user=${btoa(data.author)}'">
                üë§ ${data.author.split('@')[0]}
            </small>
        </div>
        <textarea placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å...">${data.text || ''}</textarea>
        <button class="admin-only" style="border-radius:8px;">–£–¥–∞–ª–∏—Ç—å</button>
    `;
    document.getElementById('board').prepend(div);
    
    const area = div.querySelector('textarea');
    if (auth.currentUser && (auth.currentUser.email === data.author || auth.currentUser.email === ADMIN_EMAIL)) {
        area.oninput = (e) => update(ref(db, `walls/${wallId}/${id}`), {text: e.target.value});
        div.querySelector('button').style.display = 'block';
        div.querySelector('button').onclick = () => remove(ref(db, `walls/${wallId}/${id}`));
    } else {
        area.readOnly = true;
    }
  });

  onChildChanged(cardsRef, snap => {
    const area = document.getElementById(snap.key)?.querySelector('textarea');
    if (area && document.activeElement !== area) area.value = snap.val().text;
  });

  onChildRemoved(cardsRef, snap => document.getElementById(snap.key)?.remove());
</script>
</body>
</html>
